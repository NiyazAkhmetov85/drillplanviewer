// utils/geotransform.js

import proj4 from 'proj4';

// ----------------------------------------------------------------------
// 1. КОНФИГУРАЦИЯ USLOVWGS
// ----------------------------------------------------------------------

// Параметры начала системы координат (из Отчета )
const LAT_0_DMS = "53d 24m 47.53s N"; // Широта начала системы координат
const LON_0_DMS = "69d 14m 18.99s E"; // Долгота начала системы координат
const SCALE_FACTOR = 1.000097549103; // Масштаб 

// Параметры трансформации (линейные сдвиги)
// Примечание: Это параметры "В один шаг" [cite: 11] (Helmert/Affine)
// Мы используем их как False Easting/Northing для упрощения в Proj4, 
// а остальные параметры (x0, y0, A, B, C) опускаем, т.к. их формула неизвестна.
const FALSE_EASTING = 4458.9140; // Δx 
const FALSE_NORTHING = 7317.3475; // Δy 

// Перевод из Град/Минут/Секунд в Десятичные градусы
const lat0 = proj4.toGeographic(LAT_0_DMS);
const lon0 = proj4.toGeographic(LON_0_DMS);

// ----------------------------------------------------------------------
// 2. ОПРЕДЕЛЕНИЕ СИСТЕМ КООРДИНАТ
// ----------------------------------------------------------------------

// A. WGS 84 (EPSG:4326) - Географическая, стандарт для глобальных карт
const WGS84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";

// B. USLOVWGS - Локальная система, определенная как Поперечный Меркатор 
// (Transverse Mercator - стандарт для плоских систем), привязанный к WGS 84.
// Примечание: Поскольку "Проекция: Нет"[cite: 9], мы используем TM как лучшую 
// аппроксимацию для плоской системы в этом масштабе.
const USLOVWGS_DEF = `+proj=tmerc +lat_0=${lat0} +lon_0=${lon0} 
                      +k=${SCALE_FACTOR} +x_0=${FALSE_EASTING} +y_0=${FALSE_NORTHING} 
                      +ellps=WGS84 +units=m +no_defs`;

// ----------------------------------------------------------------------
// 3. ФУНКЦИЯ ТРАНСФОРМАЦИИ
// ----------------------------------------------------------------------

/**
 * Выполняет обратную трансформацию из USLOVWGS (Восток, Север) в WGS 84 (Широта, Долгота).
 * * @param {number} easting Координата Восток (X) в USLOVWGS.
 * @param {number} northing Координата Север (Y) в USLOVWGS.
 * @returns {number[]} Массив [широта, долгота] в WGS 84.
 */
export function transformUSLOVtoWGS84(easting, northing) {
    try {
        // [Восток, Север] -> [Долгота, Широта]
        const [longitude, latitude] = proj4(USLOVWGS_DEF, WGS84, [easting, northing]);
        
        // Leaflet ожидает формат [Широта, Долгота]
        return [latitude, longitude]; 
    } catch (error) {
        console.error("Ошибка при трансформации USLOVWGS -> WGS84:", error);
        return [null, null];
    }
}

// ----------------------------------------------------------------------
// ПРОВЕРКА (Используйте для отладки)
// ----------------------------------------------------------------------
/* // Контрольная точка 1 из Отчета (Система В [cite: 26])
const testEasting = 9304.1700; 
const testNorthing = 4338.8300;
const [testLat, testLon] = transformUSLOVtoWGS84(testEasting, testNorthing);

// Ожидаемые координаты WGS 84 (Долгота, Широта)
// Точка 1 в Декартовых WGS84 (Система А [cite: 24]): X: 1 348 737.0832, Y: 3 563 393.2489, Z: 5 098 157.1309
// Для проверки нужен внешний геодезический калькулятор.
// console.log(`Тестовая точка USLOVWGS [${testEasting}, ${testNorthing}] -> WGS84 [${testLat}, ${testLon}]`);
*/
